import test from '@interactjs/_dev/test/test';
import interactions from '@interactjs/core/interactions';
import { ActionName } from '@interactjs/core/scope';
import * as helpers from '@interactjs/core/tests/_helpers';
import { extend } from '@interactjs/utils';
import pointerUtils from '@interactjs/utils/pointerUtils';
import drag from './drag';
test('drag action init', (t) => {
    const scope = helpers.mockScope();
    drag.install(scope);
    t.ok(scope.actions.names.includes(ActionName.Drag), '"drag" in actions.names');
    t.equal(scope.actions.methodDict.drag, 'draggable');
    t.equal(typeof scope.Interactable.prototype.draggable, 'function');
    t.end();
});
test('Interactable.draggable method', (t) => {
    const interactable = {
        options: {
            drag: {},
        },
        draggable: drag.draggable,
        setPerAction: () => { calledSetPerAction = true; },
        setOnEvents: () => { calledSetOnEvents = true; },
    };
    let calledSetPerAction = false;
    let calledSetOnEvents = false;
    t.equal(interactable.draggable(), interactable.options.drag, 'interactable.draggable() returns interactable.options.drag object');
    interactable.draggable(true);
    t.ok(interactable.options.drag.enabled, 'calling `interactable.draggable(true)` enables dragging');
    interactable.draggable(false);
    t.notOk(interactable.options.drag.enabled, 'calling `interactable.draggable(false)` disables dragging');
    interactable.draggable({});
    t.ok(interactable.options.drag.enabled, 'calling `interactable.draggable({})` enables dragging');
    t.ok(calledSetOnEvents, 'calling `interactable.draggable({})` calls this.setOnEvents');
    t.ok(calledSetPerAction, 'calling `interactable.draggable({})` calls this.setPerAction');
    interactable.draggable({ enabled: false });
    t.notOk(interactable.options.drag.enabled, 'calling `interactable.draggable({ enabled: false })` disables dragging');
    const axisSettings = {
        lockAxis: ['x', 'y', 'xy', 'start'],
        startAxis: ['x', 'y', 'xy'],
    };
    for (const axis in axisSettings) {
        for (const value of axisSettings[axis]) {
            const options = {};
            options[axis] = value;
            interactable.draggable(options);
            t.equal(interactable.options.drag[axis], value, '`' + axis + ': "' + value + '"` is set correctly');
            delete interactable.options.drag[axis];
        }
    }
    t.end();
});
test('drag axis', (t) => {
    const scope = helpers.mockScope();
    interactions.install(scope);
    drag.install(scope);
    const interaction = scope.interactions.new({});
    const element = {};
    const interactable = {
        options: {
            drag: {},
        },
        target: element,
    };
    const iEvent = { page: {}, client: {}, delta: {}, type: 'dragmove' };
    const opposites = { x: 'y', y: 'x' };
    const eventCoords = {
        page: { x: -1, y: -2 },
        client: { x: -3, y: -4 },
        delta: { x: -5, y: -6 },
    };
    const coords = helpers.newCoordsSet();
    resetCoords();
    interaction.prepared = { name: 'drag', axis: 'xy' };
    interaction.interact = interactable;
    t.test('xy (any direction)', (tt) => {
        scope.interactions.signals.fire('before-action-move', { interaction });
        tt.deepEqual(interaction.coords.start, coords.start, 'coords.start is not modified');
        tt.deepEqual(interaction.coords.delta, coords.delta, 'coords.delta is not modified');
        scope.interactions.signals.fire('action-move', { iEvent, interaction });
        tt.deepEqual(iEvent.page, eventCoords.page, 'page coords are not modified');
        tt.deepEqual(iEvent.delta, eventCoords.delta, 'delta is not modified');
        tt.end();
    });
    for (const axis in opposites) {
        const opposite = opposites[axis];
        t.test(axis + '-axis', (tt) => {
            resetCoords();
            interaction.prepared.axis = axis;
            scope.interactions.signals.fire('action-move', { iEvent, interaction });
            tt.deepEqual(iEvent.delta, {
                [opposite]: 0,
                [axis]: eventCoords.delta[axis],
            }, `opposite axis (${opposite}) delta is 0; target axis (${axis}) delta is not modified`);
            tt.deepEqual(iEvent.page, {
                [opposite]: coords.start.page[opposite],
                [axis]: eventCoords.page[axis],
            }, `page.${opposite} is coords.start value`);
            tt.equal(iEvent.page[axis], eventCoords.page[axis], `page.${axis} is not modified`);
            tt.equal(iEvent.client[opposite], coords.start.client[opposite], `client.${opposite} is coords.start value`);
            tt.equal(iEvent.client[axis], eventCoords.client[axis], `client.${axis} is not modified`);
            tt.end();
        });
    }
    t.end();
    function resetCoords() {
        pointerUtils.copyCoords(iEvent, eventCoords);
        extend(iEvent.delta, eventCoords.delta);
        for (const prop in coords) {
            pointerUtils.copyCoords(interaction.coords[prop], coords[prop]);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZy5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHJhZy5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLDRCQUE0QixDQUFBO0FBQzdDLE9BQU8sWUFBWSxNQUFNLCtCQUErQixDQUFBO0FBQ3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUNuRCxPQUFPLEtBQUssT0FBTyxNQUFNLGlDQUFpQyxDQUFBO0FBQzFELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQTtBQUMxQyxPQUFPLFlBQVksTUFBTSxnQ0FBZ0MsQ0FBQTtBQUN6RCxPQUFPLElBQUksTUFBTSxRQUFRLENBQUE7QUFFekIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDN0IsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBRWpDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFbkIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLHlCQUF5QixDQUFDLENBQUE7SUFDOUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDbkQsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUVsRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUE7QUFDVCxDQUFDLENBQUMsQ0FBQTtBQUVGLElBQUksQ0FBQywrQkFBK0IsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO0lBQzFDLE1BQU0sWUFBWSxHQUFHO1FBQ25CLE9BQU8sRUFBRTtZ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SUFBSSxJQUFJLE1BQU0sRUFBRTtZQUN6QixZQUFZLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7U0FDaEU7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdGVzdCBmcm9tICdAaW50ZXJhY3Rqcy9fZGV2L3Rlc3QvdGVzdCdcbmltcG9ydCBpbnRlcmFjdGlvbnMgZnJvbSAnQGludGVyYWN0anMvY29yZS9pbnRlcmFjdGlvbnMnXG5pbXBvcnQgeyBBY3Rpb25OYW1lIH0gZnJvbSAnQGludGVyYWN0anMvY29yZS9zY29wZSdcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnQGludGVyYWN0anMvY29yZS90ZXN0cy9faGVscGVycydcbmltcG9ydCB7IGV4dGVuZCB9IGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzJ1xuaW1wb3J0IHBvaW50ZXJVdGlscyBmcm9tICdAaW50ZXJhY3Rqcy91dGlscy9wb2ludGVyVXRpbHMnXG5pbXBvcnQgZHJhZyBmcm9tICcuL2RyYWcnXG5cbnRlc3QoJ2RyYWcgYWN0aW9uIGluaXQnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZSA9IGhlbHBlcnMubW9ja1Njb3BlKClcblxuICBkcmFnLmluc3RhbGwoc2NvcGUpXG5cbiAgdC5vayhzY29wZS5hY3Rpb25zLm5hbWVzLmluY2x1ZGVzKEFjdGlvbk5hbWUuRHJhZyksICdcImRyYWdcIiBpbiBhY3Rpb25zLm5hbWVzJylcbiAgdC5lcXVhbChzY29wZS5hY3Rpb25zLm1ldGhvZERpY3QuZHJhZywgJ2RyYWdnYWJsZScpXG4gIHQuZXF1YWwodHlwZW9mIHNjb3BlLkludGVyYWN0YWJsZS5wcm90b3R5cGUuZHJhZ2dhYmxlLCAnZnVuY3Rpb24nKVxuXG4gIHQuZW5kKClcbn0pXG5cbnRlc3QoJ0ludGVyYWN0YWJsZS5kcmFnZ2FibGUgbWV0aG9kJywgKHQpID0+IHtcbiAgY29uc3QgaW50ZXJhY3RhYmxlID0ge1xuICAgIG9wdGlvbnM6IHtcbiAgICAgIGRyYWc6IHt9LFxuICAgIH0sXG4gICAgZHJhZ2dhYmxlOiBkcmFnLmRyYWdnYWJsZSxcbiAgICBzZXRQZXJBY3Rpb246ICgpID0+IHsgY2FsbGVkU2V0UGVyQWN0aW9uID0gdHJ1ZSB9LFxuICAgIHNldE9uRXZlbnRzOiAoKSA9PiB7IGNhbGxlZFNldE9uRXZlbnRzID0gdHJ1ZSB9LFxuICB9IGFzIHVua25vd24gYXMgSW50ZXJhY3QuSW50ZXJhY3RhYmxlXG4gIGxldCBjYWxsZWRTZXRQZXJBY3Rpb24gPSBmYWxzZVxuICBsZXQgY2FsbGVkU2V0T25FdmVudHMgPSBmYWxzZVxuXG4gIHQuZXF1YWwoaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSgpLCBpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnLFxuICAgICdpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKCkgcmV0dXJucyBpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnIG9iamVjdCcpXG5cbiAgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh0cnVlKVxuICB0Lm9rKGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcuZW5hYmxlZCxcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh0cnVlKWAgZW5hYmxlcyBkcmFnZ2luZycpXG5cbiAgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZShmYWxzZSlcbiAgdC5ub3RPayhpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnLmVuYWJsZWQsXG4gICAgJ2NhbGxpbmcgYGludGVyYWN0YWJsZS5kcmFnZ2FibGUoZmFsc2UpYCBkaXNhYmxlcyBkcmFnZ2luZycpXG5cbiAgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh7fSlcbiAgdC5vayhpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnLmVuYWJsZWQsXG4gICAgJ2NhbGxpbmcgYGludGVyYWN0YWJsZS5kcmFnZ2FibGUoe30pYCBlbmFibGVzIGRyYWdnaW5nJylcbiAgdC5vayhjYWxsZWRTZXRPbkV2ZW50cyxcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh7fSlgIGNhbGxzIHRoaXMuc2V0T25FdmVudHMnKVxuICB0Lm9rKGNhbGxlZFNldFBlckFjdGlvbixcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh7fSlgIGNhbGxzIHRoaXMuc2V0UGVyQWN0aW9uJylcblxuICBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHsgZW5hYmxlZDogZmFsc2UgfSlcbiAgdC5ub3RPayhpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnLmVuYWJsZWQsXG4gICAgJ2NhbGxpbmcgYGludGVyYWN0YWJsZS5kcmFnZ2FibGUoeyBlbmFibGVkOiBmYWxzZSB9KWAgZGlzYWJsZXMgZHJhZ2dpbmcnKVxuXG4gIGNvbnN0IGF4aXNTZXR0aW5ncyA9IHtcbiAgICBsb2NrQXhpczogWyd4JywgJ3knLCAneHknLCAnc3RhcnQnXSxcbiAgICBzdGFydEF4aXM6IFsneCcsICd5JywgJ3h5J10sXG4gIH1cblxuICBmb3IgKGNvbnN0IGF4aXMgaW4gYXhpc1NldHRpbmdzKSB7XG4gICAgZm9yIChjb25zdCB2YWx1ZSBvZiBheGlzU2V0dGluZ3NbYXhpc10pIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7fVxuXG4gICAgICBvcHRpb25zW2F4aXNdID0gdmFsdWVcblxuICAgICAgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZShvcHRpb25zKVxuICAgICAgdC5lcXVhbChpbnRlcmFjdGFibGUub3B0aW9ucy5kcmFnW2F4aXNdLCB2YWx1ZSxcbiAgICAgICAgJ2AnICsgYXhpcyArICc6IFwiJyArIHZhbHVlICsgJ1wiYCBpcyBzZXQgY29ycmVjdGx5JylcblxuICAgICAgZGVsZXRlIGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWdbYXhpc11cbiAgICB9XG4gIH1cblxuICB0LmVuZCgpXG59KVxuXG50ZXN0KCdkcmFnIGF4aXMnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZSA9IGhlbHBlcnMubW9ja1Njb3BlKClcblxuICBpbnRlcmFjdGlvbnMuaW5zdGFsbChzY29wZSlcbiAgZHJhZy5pbnN0YWxsKHNjb3BlKVxuXG4gIGNvbnN0IGludGVyYWN0aW9uID0gc2NvcGUuaW50ZXJhY3Rpb25zLm5ldyh7fSlcbiAgY29uc3QgZWxlbWVudCA9IHt9XG4gIGNvbnN0IGludGVyYWN0YWJsZSA9IHtcbiAgICBvcHRpb25zOiB7XG4gICAgICBkcmFnOiB7fSxcbiAgICB9LFxuICAgIHRhcmdldDogZWxlbWVudCxcbiAgfSBhcyBJbnRlcmFjdC5JbnRlcmFjdGFibGVcbiAgY29uc3QgaUV2ZW50ID0geyBwYWdlOiB7fSwgY2xpZW50OiB7fSwgZGVsdGE6IHt9LCB0eXBlOiAnZHJhZ21vdmUnIH0gYXMgSW50ZXJhY3QuSW50ZXJhY3RFdmVudFxuXG4gIGNvbnN0IG9wcG9zaXRlcyA9IHsgeDogJ3knLCB5OiAneCcgfVxuICBjb25zdCBldmVudENvb3JkcyA9IHtcbiAgICBwYWdlOiB7IHg6IC0xLCB5OiAtMiB9LFxuICAgIGNsaWVudDogeyB4OiAtMywgeTogLTQgfSxcbiAgICBkZWx0YTogeyB4OiAtNSwgeTogLTYgfSxcbiAgfVxuICBjb25zdCBjb29yZHMgPSBoZWxwZXJzLm5ld0Nvb3Jkc1NldCgpXG5cbiAgcmVzZXRDb29yZHMoKVxuICBpbnRlcmFjdGlvbi5wcmVwYXJlZCA9IHsgbmFtZTogJ2RyYWcnLCBheGlzOiAneHknIH1cbiAgaW50ZXJhY3Rpb24uaW50ZXJhY3QgPSBpbnRlcmFjdGFibGVcblxuICB0LnRlc3QoJ3h5IChhbnkgZGlyZWN0aW9uKScsICh0dCkgPT4ge1xuICAgIHNjb3BlLmludGVyYWN0aW9ucy5zaWduYWxzLmZpcmUoJ2JlZm9yZS1hY3Rpb24tbW92ZScsIHsgaW50ZXJhY3Rpb24gfSlcblxuICAgIHR0LmRlZXBFcXVhbChpbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQsIGNvb3Jkcy5zdGFydCxcbiAgICAgICdjb29yZHMuc3RhcnQgaXMgbm90IG1vZGlmaWVkJylcbiAgICB0dC5kZWVwRXF1YWwoaW50ZXJhY3Rpb24uY29vcmRzLmRlbHRhLCBjb29yZHMuZGVsdGEsXG4gICAgICAnY29vcmRzLmRlbHRhIGlzIG5vdCBtb2RpZmllZCcpXG5cbiAgICBzY29wZS5pbnRlcmFjdGlvbnMuc2lnbmFscy5maXJlKCdhY3Rpb24tbW92ZScsIHsgaUV2ZW50LCBpbnRlcmFjdGlvbiB9KVxuXG4gICAgdHQuZGVlcEVxdWFsKGlFdmVudC5wYWdlLCBldmVudENvb3Jkcy5wYWdlLCAncGFnZSBjb29yZHMgYXJlIG5vdCBtb2RpZmllZCcpXG4gICAgdHQuZGVlcEVxdWFsKGlFdmVudC5kZWx0YSwgZXZlbnRDb29yZHMuZGVsdGEsICdkZWx0YSBpcyBub3QgbW9kaWZpZWQnKVxuXG4gICAgdHQuZW5kKClcbiAgfSlcblxuICBmb3IgKGNvbnN0IGF4aXMgaW4gb3Bwb3NpdGVzKSB7XG4gICAgY29uc3Qgb3Bwb3NpdGUgPSBvcHBvc2l0ZXNbYXhpc11cblxuICAgIHQudGVzdChheGlzICsgJy1heGlzJywgKHR0KSA9PiB7XG4gICAgICByZXNldENvb3JkcygpXG4gICAgICBpbnRlcmFjdGlvbi5wcmVwYXJlZC5heGlzID0gYXhpcyBhcyBhbnlcblxuICAgICAgc2NvcGUuaW50ZXJhY3Rpb25zLnNpZ25hbHMuZmlyZSgnYWN0aW9uLW1vdmUnLCB7IGlFdmVudCwgaW50ZXJhY3Rpb24gfSlcblxuICAgICAgdHQuZGVlcEVxdWFsKFxuICAgICAgICBpRXZlbnQuZGVsdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBbb3Bwb3NpdGVdOiAwLFxuICAgICAgICAgIFtheGlzXTogZXZlbnRDb29yZHMuZGVsdGFbYXhpc10sXG4gICAgICAgIH0sXG4gICAgICAgIGBvcHBvc2l0ZSBheGlzICgke29wcG9zaXRlfSkgZGVsdGEgaXMgMDsgdGFyZ2V0IGF4aXMgKCR7YXhpc30pIGRlbHRhIGlzIG5vdCBtb2RpZmllZGApXG5cbiAgICAgIHR0LmRlZXBFcXVhbChcbiAgICAgICAgaUV2ZW50LnBhZ2UsXG4gICAgICAgIHtcbiAgICAgICAgICBbb3Bwb3NpdGVdOiBjb29yZHMuc3RhcnQucGFnZVtvcHBvc2l0ZV0sXG4gICAgICAgICAgW2F4aXNdOiBldmVudENvb3Jkcy5wYWdlW2F4aXNdLFxuICAgICAgICB9LFxuICAgICAgICBgcGFnZS4ke29wcG9zaXRlfSBpcyBjb29yZHMuc3RhcnQgdmFsdWVgXG4gICAgICApXG5cbiAgICAgIHR0LmVxdWFsKFxuICAgICAgICBpRXZlbnQucGFnZVtheGlzXSxcbiAgICAgICAgZXZlbnRDb29yZHMucGFnZVtheGlzXSxcbiAgICAgICAgYHBhZ2UuJHtheGlzfSBpcyBub3QgbW9kaWZpZWRgXG4gICAgICApXG5cbiAgICAgIHR0LmVxdWFsKFxuICAgICAgICBpRXZlbnQuY2xpZW50W29wcG9zaXRlXSxcbiAgICAgICAgY29vcmRzLnN0YXJ0LmNsaWVudFtvcHBvc2l0ZV0sXG4gICAgICAgIGBjbGllbnQuJHtvcHBvc2l0ZX0gaXMgY29vcmRzLnN0YXJ0IHZhbHVlYFxuICAgICAgKVxuICAgICAgdHQuZXF1YWwoXG4gICAgICAgIGlFdmVudC5jbGllbnRbYXhpc10sXG4gICAgICAgIGV2ZW50Q29vcmRzLmNsaWVudFtheGlzXSxcbiAgICAgICAgYGNsaWVudC4ke2F4aXN9IGlzIG5vdCBtb2RpZmllZGBcbiAgICAgIClcblxuICAgICAgdHQuZW5kKClcbiAgICB9KVxuICB9XG5cbiAgdC5lbmQoKVxuXG4gIGZ1bmN0aW9uIHJlc2V0Q29vcmRzICgpIHtcbiAgICBwb2ludGVyVXRpbHMuY29weUNvb3JkcyhpRXZlbnQsIGV2ZW50Q29vcmRzKVxuICAgIGV4dGVuZChpRXZlbnQuZGVsdGEsIGV2ZW50Q29vcmRzLmRlbHRhKVxuXG4gICAgZm9yIChjb25zdCBwcm9wIGluIGNvb3Jkcykge1xuICAgICAgcG9pbnRlclV0aWxzLmNvcHlDb29yZHMoaW50ZXJhY3Rpb24uY29vcmRzW3Byb3BdLCBjb29yZHNbcHJvcF0pXG4gICAgfVxuICB9XG59KVxuIl19